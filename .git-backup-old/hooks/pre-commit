#!/bin/bash

# LENS Pre-commit Hook
# Runs tests and linting before commit

set -e

echo "🔍 Running pre-commit checks..."

# Check if Node.js is available
if ! command -v node &> /dev/null; then
    echo "❌ Node.js not found"
    exit 1
fi

# Install dependencies if needed
if [ ! -d "node_modules" ]; then
    echo "📦 Installing dependencies..."
    npm install
fi

# Generate Prisma client if needed
if [ ! -d "node_modules/.prisma" ]; then
    echo "🔧 Generating Prisma client..."
    npx prisma generate
fi

# Run linting
echo "🧹 Running ESLint..."
npm run lint || {
    echo "❌ Linting failed. Please fix the issues before committing."
    exit 1
}

# Run type checking
echo "🔍 Running TypeScript check..."
npx tsc --noEmit || {
    echo "❌ TypeScript check failed. Please fix the issues before committing."
    exit 1
}

# Build frontend if changed
if git diff --cached --name-only | grep -q "src/frontend/"; then
    echo "🏗️ Building frontend..."
    cd src/frontend
    npm run build || {
        echo "❌ Frontend build failed."
        exit 1
    }
    cd ../..
fi

echo "✅ Pre-commit checks passed!"