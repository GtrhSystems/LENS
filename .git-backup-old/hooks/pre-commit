#!/bin/bash

# LENS Pre-commit Hook
# Runs tests and linting before commit

set -e

echo "ğŸ” Running pre-commit checks..."

# Check if Node.js is available
if ! command -v node &> /dev/null; then
    echo "âŒ Node.js not found"
    exit 1
fi

# Install dependencies if needed
if [ ! -d "node_modules" ]; then
    echo "ğŸ“¦ Installing dependencies..."
    npm install
fi

# Generate Prisma client if needed
if [ ! -d "node_modules/.prisma" ]; then
    echo "ğŸ”§ Generating Prisma client..."
    npx prisma generate
fi

# Run linting
echo "ğŸ§¹ Running ESLint..."
npm run lint || {
    echo "âŒ Linting failed. Please fix the issues before committing."
    exit 1
}

# Run type checking
echo "ğŸ” Running TypeScript check..."
npx tsc --noEmit || {
    echo "âŒ TypeScript check failed. Please fix the issues before committing."
    exit 1
}

# Build frontend if changed
if git diff --cached --name-only | grep -q "src/frontend/"; then
    echo "ğŸ—ï¸ Building frontend..."
    cd src/frontend
    npm run build || {
        echo "âŒ Frontend build failed."
        exit 1
    }
    cd ../..
fi

echo "âœ… Pre-commit checks passed!"